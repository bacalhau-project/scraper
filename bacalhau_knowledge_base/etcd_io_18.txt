Source: etcd_io
URL: https://etcd.io/blog/2020/jepsen-343-results/

etcdDocsBlogCommunityInstallPlayVersionsv3.6v3.5v3.4v3.3v3.2v3.1v2.3BlogEngage with the etcd project at KubeCon NA 2023Introducing sig-etcdHow to debug large db size issue?etcd Integrates Continuous FuzzingAnnouncing etcd 3.5Latest Jepsen Results against etcd 3.4.3Container Linux with systemdDeployment of etcd on AWS EC2FreeBSDView page sourceEdit this pageCreate child pageCreate documentation issueCreate project issueWhat went well1. A simple core2. Rigorous testing practiceIdentified IssuesLock IssuesDocumentation IssuesAddressing Identified IssuesFutureLatest Jepsen Results against etcd 3.4.3ByXiang Li|Thursday, January 30, 2020Jepsen tested and analyzed etcd 3.4.3, and had both good results and useful feedback to share with us.A key part of etcd’s design is strong consistency guarantees across the distributed key-value store. Kubernetes, Rook, OpenStack, and countless other critical software projects rely on etcd, in part, because of the etcd project’s focus on reliability and correctness.Over the years, the etcd team has put tremendous effort on buildingtestingandchaos engineering frameworks. We feel that we’ve improved our consistency, and have asked Jepsen for validation.Jepsenis the leading company testing open source distributed systems to check if they fulfill their consistency guarantees. They first tested etcd in version 0.4.1, and we have been using these findings ever since to improve our consistency. In this blog post, we share the overall positive results of the Jepsen analysis of etcd v3.4.3 as well as our plans to resolve the issues found in the analysis.Funding for Jepsen’s work was provided by theCloud Native Computing Foundation, which hosts etcd.What went wellDuring the numerous failure cases created by Jepsen against an etcd cluster, it continued to perform as designed. From the analysis, the Jepsen author says:etcd 3.4.3 lived up to its claims for key-value operations: we observed nothing but strict-serializable consistency for reads, writes, and even multi-key transactions, during process pauses, crashes, clock skew, network partitions, and membership changes. Strict serializable behavior was the default for key-value operations.Watches appear correct, at least over single keys. So long as compaction does not destroy historical data while a watch isn’t running, watches appear to deliver every update to a key in order.Since Jepsen never “passes” software, but rather reports a lack of prohibitive issues, this is a great result from them. In general, it’s much better thanother distributed databasestested to date.We believe two factors contribute to this positive result to the rigorous Jepsen analysis:1. A simple coreA simple solution to a problem space usually results in a robust system. As an example, etcd’s Raft implementation is one of the simplest implementations in open source. It focuses on the core state machine of Raft and avoids wall-time and I/O handling in the core library. And, in its API, etcd supports multi-key transactions, but adopts a simple transactional model to keep the system easier to comprehend.2. Rigorous testing practiceEarly in the development cycle of etcd, we set a goal toachieve 80% unit test line coverageand 90% unit test line coverage over core components like Raft and the MVCC storage engine. As the project progressed, we put effort into ensuring logical path coverage for core components byintroducing fail points. To embrace the randomness of timing, OS scheduling and asynchronous network I/Os, we also developed continuous integration tests, which run 24x7, to try and produce issues on a running system in a way that unit tests simply cannot. These tests have increased the quality of etcd significantly.Identified IssuesOf course, no system undergoes Jepsen testing without them reporting some areas where it could be better. etcd had a few:Lock IssuesOne lock implementation issue was found during the test where etcd failed to check the ownership of the lock before the pending lock API call returned.In etcd, a lock acquirer is associated with a session; the acquirer holds the lock until the session expires. When first attempting to acquire the lock, it may be held by someone else. In that case, the etcd server puts the acquirer into a queue, where it must wait until other lock holders release the lock. The problem is that the acquirer’s session might expire during this wait time. The consequence of this premature expiration is that the etcd server must check the existence of the session again before returning to the API call.Documentation IssuesThe Jepsen analysis not only covers software correctness but also verifies the documentation claims. The Jepsen author found documentation issues and misleading use case examples of etcd. The previous etcd documentation on consistency and isolation is not clear and might cause confusion.Our documentation describes the consistency model based onthe Wikipedia definition, which is also the classification some etcd engineerslearned in University. It also separates the isolation level from consistency level, as there is no general agreement onhow the two should be defined together.The Jepsen author suggests etcd documentation adopt the term “strict serializability” originally defined in theLinearizability paper published by Herlihy and Wing. After reading the documentation on other open source projects, as well as listening to feedback from our users, the etcd team agrees with the Jepsen author that thesuggested model and termare clearer and easier to understand.Next, the lock API use case example is misleading and might cause runtime issues.Like any other distributed lock system, an etcd lock provides different guarantees than say a local thread level lock. Specifically, an etcd lock only safely guarantees mutual exclusion inside etcd’s own keyspace and transactions with revision checking. It provides weaker guarantee when accessing external resources with dependency on timing. Deadlock prevention and lock invalidation is difficult with distributed locks because a distributed lock does not protect resources within the same process, or even the same machine. To address this, distributed locks traditionally rely on a lease and heartbeat mechanism to detect disconnected lock holders and invalidate locks. When a lock holder is disconnected or paused without using revision checking (a fencing token implementation in etcd), it might access the protected resources simultaneously with the new lock holder. More details can be foundin Kleppmann’s blog post.The etcd lock documentation fails to point out this difference and provides inaccurate examples of using the lock. We agree with the Jepsen team that the issues must be resolved, and etcd users should be informed with the accurate claims.Addressing Identified IssuesAll the issues mentioned above are being addressed by the etcd team and the Jepsen team. Here is the list of issues and fixes. We appreciate feedback from community over these issues and help the etcd project become better.Analysis IssuesGithub IssueStatus on 1/30Lock implementation11408FixedWatch API defaulting documentation11496FixedConsistency documentation11474FixedLock documentation11490Work in progressFutureJepsen analysis is not a one time effort. During the analysis, the Jepsen team set up an extensive testing framework for the etcd project specifically. It also enables etcd team and the community to run those tests anytime and catch problems in the future.We would love to see someone in the etcd community integrate the etcd Jepsen tests directly into the existing etcd release pipeline. We hope to ensure that all future releases of etcd are Jepsen tests approved.Besides Jepsen analysis, etcd community always welcome contributions related to correctness and reliability. We are excited about the results of this testing, and will remain vigilant while building a well engineered and correct product.To learn more read the fullJepsen report for etcd 3.4.3.←PreviousNext→Last modified April 27, 2021:updating jepsen-343-results frontmatter (#259) (197c5ff)©
2013–2024etcd AuthorsTerms|Privacy|Trademarks|LicenseAll Rights Reserved